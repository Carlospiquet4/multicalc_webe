<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Porcentagem de Faltas</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --secondary-color: #f8fafc;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --card-shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --border-radius: 12px;
            --gradient-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gradient-bg);
            min-height: 100vh;
            padding: 2rem 1rem;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .main-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow-lg);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .card-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .card-header p {
            opacity: 0.9;
            font-weight: 300;
        }

        .card-body {
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 0.7rem;
        }

        label {
            display: block;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="email"],
        textarea {
            width: 100%;
            max-width: 420px;
            margin-left: auto;
            margin-right: auto;
            display: block;
            padding: 0.7rem 1rem;
            border: 1.5px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.97rem;
            background: #f3f6fa;
            color: var(--text-primary);
            box-shadow: 0 1px 4px rgba(37, 99, 235, 0.06);
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
        }

        input[type="text"]::placeholder,
        input[type="number"]::placeholder,
        input[type="date"]::placeholder,
        input[type="email"]::placeholder,
        textarea::placeholder {
            color: #8a99b5;
            opacity: 1;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        input[type="email"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background: #eaf0fb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.10);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            font-family: inherit;
            min-width: 120px;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: var(--text-secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .alert {
            color: red;
            font-weight: bold;
        }

        .nome-alerta {
            color: red;
        }

        #resultado {
            margin-top: 20px;
            text-align: center;
        }

        .footer {
            text-align: center;
            margin-top: 3rem;
            color: white;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .footer a {
            color: white;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .card-body {
                padding: 1rem;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Calculadora de Porcentagem de Faltas</h1>
            <p>Calcule e visualize suas faltas de forma moderna</p>
        </div>
        <div class="main-card">
            <div class="card-header">
                <h2>Controle de Faltas</h2>
                <p>Preencha os dados abaixo</p>
            </div>
            <div class="card-body">
                <form id="faltaForm" onsubmit="return false;">
                    <div class="form-group">
                        <label for="nome">Nome:</label>
                        <input type="text" id="nome" required>
                    </div>
                    <div class="form-group">
                        <label for="email">E-mail:</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="turma">Nome da Turma:</label>
                        <input type="text" id="turma" required>
                    </div>
                    <div class="form-group">
                        <label for="matricula">Matrícula:</label>
                        <input type="text" id="matricula" required>
                    </div>
                    <div class="form-group">
                        <label for="admissao">Admissão:</label>
                        <input type="date" id="admissao" required>
                    </div>
                    <div class="form-group periodo-group">
                        <div>
                            <label for="periodoInicio">Período de:</label>
                            <input type="date" id="periodoInicio" required>
                        </div>
                        <div>
                            <label for="periodoFim">Até:</label>
                            <input type="date" id="periodoFim" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="eventos">Número de Eventos:</label>
                        <input type="number" id="eventos" min="1" max="12" required onchange="gerarCamposEventos()">
                    </div>
                    <div id="eventosContainer"></div>
                    <div class="button-group">
                        <button type="button" class="btn btn-success" onclick="calcularFaltas()"><i class="fas fa-percent"></i>
                            Calcular</button>
                        <button type="button" class="btn btn-warning" onclick="gerarPDF()"><i class="fas fa-file-pdf"></i>
                            Gerar PDF</button>
                        <button type="button" class="btn btn-primary" onclick="addStudent()"><i class="fas fa-user-plus"></i>
                            Adicionar Aluno</button>
                        <button type="button" class="btn btn-secondary" onclick="exportAllData()"><i class="fas fa-file-excel"></i>
                            Exportar para Excel</button>
                        <button type="button" class="btn btn-danger" onclick="novaTurma()"><i class="fas fa-redo"></i> Nova
                            Turma</button>
                        <button type="button" class="btn btn-info"
                            onclick="window.location.href='desempenho.html'">Análise Acadêmica Integral</button>
                    </div>
                </form>
                <div id="resultado"></div>
                <canvas id="graficoDesempenho" width="400" height="200"></canvas>
            </div>
        </div>
        <div class="footer">
            <p>Desenvolvido por Carlos Antonio de Oliveira Piquet</p>
        </div>
    </div>
    <script>
        let studentsData = []; // Array para armazenar os dados dos alunos
        let chart; // Variável global para armazenar o gráfico

        function gerarCamposEventos() {
            let numEventos = parseInt(document.getElementById('eventos').value);
            const container = document.getElementById('eventosContainer');
            container.innerHTML = ''; // Limpa o container

            if (numEventos > 12) {
                numEventos = 12;
                document.getElementById('eventos').value = 12;
            }

            for (let i = 0; i < numEventos; i++) {
                const eventoGroup = document.createElement('div');
                eventoGroup.className = 'evento-group';
                eventoGroup.innerHTML = `
                    <input type="date" placeholder="Data Evento" class="dataEvento" required>
                    <input type="text" placeholder="Nome do Evento" class="nomeMateria" maxlength="80" required>
                    <input type="text" placeholder="P/F/J" class="statusEvento" required>
                    <textarea placeholder="Observação Justificativa" class="obsJustificativa" maxlength="40" style="display: none;"></textarea>
                `;
                container.appendChild(eventoGroup);
            }

            document.querySelectorAll('.statusEvento').forEach(input => {
                input.addEventListener('change', (e) => {
                    const parent = e.target.parentElement;
                    const obsJustificativa = parent.querySelector('.obsJustificativa');
                    if (e.target.value.toUpperCase() === 'J') {
                        obsJustificativa.style.display = 'block';
                    } else {
                        obsJustificativa.style.display = 'none';
                    }
                });
            });
        }

        function addStudent() {
            const nome = document.getElementById('nome').value;
            const email = document.getElementById('email').value;
            const turma = document.getElementById('turma').value;
            const matricula = document.getElementById('matricula').value;
            const admissao = document.getElementById('admissao').value;
            const periodoInicio = document.getElementById('periodoInicio').value;
            const periodoFim = document.getElementById('periodoFim').value;

            const eventos = [];
            const dataEventos = document.querySelectorAll('.dataEvento');
            const nomeMaterias = document.querySelectorAll('.nomeMateria');
            const statusEventos = document.querySelectorAll('.statusEvento');

            dataEventos.forEach((input, index) => {
                const dataEvento = input.value;
                const nomeMateria = nomeMaterias[index].value;
                const status = statusEventos[index].value;
                const obsJustificativa = document.querySelectorAll('.obsJustificativa')[index].value;

                eventos.push({ data: dataEvento, nomeMateria, status, obsJustificativa });
            });

            const student = {
                nome,
                email,
                turma,
                matricula,
                admissao,
                periodoInicio,
                periodoFim,
                eventos
            };

            studentsData.push(student); // Adiciona o aluno ao array
            alert('Aluno adicionado com sucesso!');

            // Limpa os campos de entrada, mas mantém os eventos
            document.getElementById('nome').value = '';
            document.getElementById('email').value = '';
            document.getElementById('turma').value = '';
            document.getElementById('matricula').value = '';
            document.getElementById('admissao').value = '';
            document.getElementById('periodoInicio').value = '';
            document.getElementById('periodoFim').value = '';

            // Zera os campos de presença, falta e justificativa
            statusEventos.forEach(input => {
                input.value = ''; // Limpa o status (P/F/J)
            });

            const obsInputs = document.querySelectorAll('.obsJustificativa');
            obsInputs.forEach(input => {
                input.value = ''; // Limpa a observação justificativa
                input.style.display = 'none'; // Oculta o campo de observação
            });
        }

        function exportAllData() {
            const ws = XLSX.utils.json_to_sheet(studentsData.map(student => {
                let presencas = 0,
                    faltas = 0,
                    justificativas = 0;

                student.eventos.forEach(event => {
                    const status = event.status.toUpperCase();
                    if (status === 'P') presencas++;
                    else if (status === 'F') faltas++;
                    else if (status === 'J') justificativas++;
                });

                const totalEventos = student.eventos.length;
                const percentFaltas = Math.round((faltas / totalEventos) * 100); // Arredondando para o inteiro mais próximo

                return {
                    Nome: student.nome,
                    Email: student.email,
                    Turma: student.turma,
                    Matrícula: student.matricula,
                    Admissão: student.admissao,
                    Período_Inicial: student.periodoInicio,
                    Período_Final: student.periodoFim,
                    Total_de_Presenças: presencas,
                    Total_de_Faltas: faltas,
                    Total_de_Justificativas: justificativas,
                    Porcentagem_de_Faltas: percentFaltas + '%' // Concatenando o símbolo '%'
                };
            }));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Dados dos Alunos');
            XLSX.writeFile(wb, 'dados_alunos.xlsx');
        }

        function novaTurma() {
            location.reload();
        }

        function calcularFaltas() {
            const statusEventos = document.querySelectorAll('.statusEvento');
            let presencas = 0,
                faltas = 0,
                justificativas = 0;

            statusEventos.forEach(input => {
                const status = input.value.toUpperCase();
                if (status === 'P') presencas++;
                else if (status === 'F') faltas++;
                else if (status === 'J') justificativas++;
            });

            const totalEventos = statusEventos.length;
            const percentPresencas = (presencas / totalEventos) * 100;
            const percentFaltas = (faltas / totalEventos) * 100;
            const percentJustificativas = (justificativas / totalEventos) * 100;

            let resultado = `Presenças: ${presencas}, Faltas: ${faltas}, Justificativas: ${justificativas}`;
            resultado += `<br>Porcentagem de Faltas: ${percentFaltas.toFixed(2)}%`;

            if (percentFaltas > 26.00) {
                resultado += ' <span class="alert">Atenção!</span>';
                document.getElementById('nome').classList.add('nome-alerta'); // Adiciona a classe para mudar a cor
            } else {
                document.getElementById('nome').classList.remove('nome-alerta'); // Remove a classe caso a condição não seja satisfeita
            }

            if (percentFaltas >= 75) {
                resultado += ' <span class="alert">Taxa de Faltas Alta!</span>';
            }

            document.getElementById('resultado').innerHTML = resultado;

            // Renderiza o gráfico com os dados atualizados
            renderizarGrafico(percentPresencas, percentFaltas, percentJustificativas);
        }

        function renderizarGrafico(percentPresencas, percentFaltas, percentJustificativas) {
            const ctx = document.getElementById('graficoDesempenho').getContext('2d');
            if (chart) {
                chart.destroy(); // Destrói o gráfico existente se já houver um
            }
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Presenças (%)', 'Faltas (%)', 'Justificativas (%)'],
                    datasets: [{
                        label: 'Desempenho do Aluno',
                        data: [percentPresencas, percentFaltas, percentJustificativas],
                        backgroundColor: [
                            'rgba(0, 0, 255, 0.2)', // Azul caneta
                            'rgba(255, 0, 0, 0.2)', // Vermelho
                            'rgba(0, 128, 0, 0.2)' // Verde
                        ],
                        borderColor: [
                            'rgba(0, 0, 255, 1)', // Azul caneta
                            'rgba(255, 0, 0, 1)', // Vermelho
                            'rgba(0, 128, 0, 1)' // Verde
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    plugins: {
                        datalabels: {
                            color: 'black',
                            font: {
                                weight: 'bold',
                                size: 12
                            },
                            formatter: function (value) {
                                return value.toFixed(2) + '%';
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function formatarData(data) {
            const partes = data.split('-');
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }

        function quebrarTexto(texto, larguraMaxima, doc) {
            return doc.splitTextToSize(texto, larguraMaxima);
        }

        async function gerarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const nome = document.getElementById('nome').value;
            const email = document.getElementById('email').value;
            const turma = document.getElementById('turma').value;
            const matricula = document.getElementById('matricula').value;
            const admissao = formatarData(document.getElementById('admissao').value);
            const periodoInicio = formatarData(document.getElementById('periodoInicio').value);
            const periodoFim = formatarData(document.getElementById('periodoFim').value);

            let presencas = 0,
                faltas = 0,
                justificativas = 0;

            const statusEventos = document.querySelectorAll('.statusEvento');
            const dataEventos = document.querySelectorAll('.dataEvento');
            const nomeMaterias = document.querySelectorAll('.nomeMateria');
            const obsJustificativas = document.querySelectorAll('.obsJustificativa');

            statusEventos.forEach(input => {
                const status = input.value.toUpperCase();
                if (status === 'P') presencas++;
                else if (status === 'F') faltas++;
                else if (status === 'J') justificativas++;
            });

            const totalEventos = statusEventos.length;
            const percentPresencas = (presencas / totalEventos) * 100;
            const percentFaltas = (faltas / totalEventos) * 100;
            const percentJustificativas = (justificativas / totalEventos) * 100;

            const marginLeft = 20;
            const marginTop = 25;
            const lineHeight = 6;
            const larguraMaximaTexto = 40;
            const larguraPagina = doc.internal.pageSize.getWidth();

            let yPos = marginTop;

            // Adiciona o gráfico na parte superior direita, alinhado com o nome
            const canvas = document.getElementById('graficoDesempenho');
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 60; // Largura do gráfico
            const imgHeight = 30; // Altura do gráfico
            const imgX = larguraPagina - imgWidth - marginLeft; // Posição X para ficar à direita
            const imgY = yPos; // Posição Y para alinhar com o nome
            doc.addImage(imgData, 'PNG', imgX, imgY, imgWidth, imgHeight);

            // Título e informações do usuário
            doc.setFont("times", "bold");
            doc.setFontSize(10);
            doc.text("Relatório de Faltas", marginLeft, yPos);
            yPos += lineHeight;

            doc.setFont("times", "normal");
            doc.setFontSize(8);

            // Alterar cor do nome para vermelho se as faltas ultrapassarem 26%
            if (percentFaltas > 26.00) {
                doc.setTextColor(255, 0, 0); // Vermelho
            } else {
                doc.setTextColor(0, 0, 0); // Preto padrão
            }
            doc.text(`Nome: ${nome}`, marginLeft, yPos);
            doc.setTextColor(0, 0, 0); // Resetar a cor para o restante do texto

            yPos += lineHeight;
            doc.text(`E-mail: ${email}`, marginLeft, yPos);
            yPos += lineHeight;
            doc.text(`Turma: ${turma}`, marginLeft, yPos);
            yPos += lineHeight;
            doc.text(`Matrícula: ${matricula}`, marginLeft, yPos);
            yPos += lineHeight;
            doc.text(`Admissão: ${admissao}`, marginLeft, yPos);
            yPos += lineHeight;
            doc.text(`Período: ${periodoInicio} até ${periodoFim}`, marginLeft, yPos);

            // Ajusta yPos para continuar o texto abaixo da altura do gráfico
            yPos = Math.max(yPos, imgY + imgHeight + lineHeight);

            yPos += lineHeight;

            doc.setFont("times", "bold");
            doc.text("Detalhes dos Eventos", larguraPagina / 2, yPos, { align: "center" });
            doc.setFont("times", "normal");
            yPos += lineHeight;
            doc.text("Evento", marginLeft, yPos);
            doc.text("Data", marginLeft + 20, yPos);
            doc.text("Nome do Evento", marginLeft + 50, yPos);
            doc.text("Status", marginLeft + 110, yPos);
            doc.text("Observação", marginLeft + 140, yPos);

            yPos += lineHeight;

            statusEventos.forEach((input, index) => {
                const status = input.value.toUpperCase();
                const dataEvento = formatarData(dataEventos[index].value);
                const nomeMateria = nomeMaterias[index].value;
                const obsJustificativa = obsJustificativas[index].value;

                if (status === 'F') {
                    doc.setTextColor(255, 0, 0);
                } else {
                    doc.setTextColor(0, 0, 0);
                }

                const textoNomeMateria = quebrarTexto(nomeMateria, larguraMaximaTexto, doc);
                const textoObsJustificativa = quebrarTexto(obsJustificativa, larguraMaximaTexto, doc);

                const maxLinhas = Math.max(textoNomeMateria.length, textoObsJustificativa.length);

                for (let linha = 0; linha < maxLinhas; linha++) {
                    if (linha === 0) {
                        doc.text(String(index + 1), marginLeft, yPos);
                        doc.text(dataEvento, marginLeft + 20, yPos);
                    }
                    doc.text(textoNomeMateria[linha] || "", marginLeft + 50, yPos);
                    if (linha === 0) {
                        doc.text(status, marginLeft + 110, yPos);
                    }
                    doc.text(textoObsJustificativa[linha] || "", marginLeft + 140, yPos);

                    yPos += lineHeight;
                }

                yPos += lineHeight / 2;
            });

            doc.setTextColor(0, 0, 0);
            yPos += lineHeight;
            doc.text(`Presenças: ${presencas}`, marginLeft, yPos);
            doc.text(`Faltas: ${faltas}`, marginLeft + 50, yPos);
            doc.text(`Justificativas: ${justificativas}`, marginLeft + 90, yPos);

            yPos += lineHeight;
            doc.text(`Porcentagem de Faltas: ${percentFaltas.toFixed(2)}%`, marginLeft, yPos);

            if (percentFaltas > 26.00) {
                yPos += lineHeight;
                doc.setTextColor(255, 0, 0);
                doc.text('Atenção!', marginLeft, yPos);
            }
            if (percentFaltas >= 75) {
                yPos += lineHeight;
                doc.text('Taxa de Faltas Alta!', marginLeft, yPos);
            }
            doc.setTextColor(0, 0, 0);

            doc.save('relatorio_faltas.pdf');

            // Limpa apenas os campos de Status e Observação Justificativa
            statusEventos.forEach(input => {
                input.value = ''; // Limpa o status (P/F/J)
            });

            obsJustificativas.forEach(input => {
                input.value = ''; // Limpa a observação justificativa
                input.style.display = 'none'; // Oculta o campo de observação
            });
        }
    </script>
</body>

</html>
